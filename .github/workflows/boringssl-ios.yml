name: boringssl-ios
on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"
permissions:
  contents: write
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install deps
        run: |
          set -euo pipefail
          sudo softwareupdate --install-rosetta --agree-to-license || true
          brew update
          brew install cmake ninja unzip || true

      - name: Build xcframework
        run: |
          set -euo pipefail
          chmod +x ci/build_boringssl_ios.sh
          ./ci/build_boringssl_ios.sh
          test -f build-out/BoringSSL.xcframework.zip

      - name: Compute metadata
        id: meta
        run: |
          set -euo pipefail
          up="$(git -C _upstream/boringssl rev-parse HEAD)"
          short="$(echo "$up" | cut -c1-12)"
          cs="$(swift package compute-checksum build-out/BoringSSL.xcframework.zip)"
          tag="ios-$(date +%Y%m%d)-${short}"
          echo "up=$up" >>"$GITHUB_OUTPUT"
          echo "cs=$cs" >>"$GITHUB_OUTPUT"
          echo "tag=$tag" >>"$GITHUB_OUTPUT"

      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag="${{ steps.meta.outputs.tag }}"
          gh release delete "$tag" -y || true
          gh release create "$tag" build-out/BoringSSL.xcframework.zip \
            --title "$tag" \
            --notes "upstream=${{ steps.meta.outputs.up }}
checksum=${{ steps.meta.outputs.cs }}"

      - name: Commit state
        run: |
          set -euo pipefail
          mkdir -p ci
          printf "%s\n" "${{ steps.meta.outputs.up }}" > ci/upstream_head.txt
          printf "%s\n" "$(date +%s)" > ci/last_success_epoch.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add ci/upstream_head.txt ci/last_success_epoch.txt
          git commit -m "ci: update state" || true
          git push || true
