name: boringssl-ios-xc

on:
  workflow_dispatch:
  schedule:
    - cron: "11 3 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps
        run: |
          set -euo pipefail
          brew update
          brew install cmake ninja unzip gh || true

      - name: Gate
        id: gate
        run: |
          set -euo pipefail
          ROOT="$PWD"
          REPO="https://boringssl.googlesource.com/boringssl"
          BRANCH="master"
          LAST="ci/last_success_epoch.txt"
          HEADF="ci/upstream_head.txt"

          now="$(date +%s)"
          last=0
          [ -f "$LAST" ] && last="$(cat "$LAST"||echo 0)"
          age=$((now-last))

          tmp="$(mktemp -d)"
          git clone --depth 1 --branch "$BRANCH" "$REPO" "$tmp/up"
          head="$(git -C "$tmp/up" rev-parse HEAD)"
          rm -rf "$tmp"

          prev=""
          [ -f "$HEADF" ] && prev="$(cat "$HEADF"||true)"

          should=1
          [ "$age" -lt 1209600 ] && should=0
          [ -n "$prev" ] && [ "$prev" = "$head" ] && should=0

          echo "head=$head" >> "$GITHUB_OUTPUT"
          echo "now=$now" >> "$GITHUB_OUTPUT"
          echo "should=$should" >> "$GITHUB_OUTPUT"

      - name: Build
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          chmod +x ci/build_boringssl_ios.sh
          ./ci/build_boringssl_ios.sh

      - name: Verify
        if: steps.gate.outputs.should == '1'
        run: |
          test -f build-out/BoringSSL.xcframework.zip

      - name: Checksum
        if: steps.gate.outputs.should == '1'
        id: sum
        run: |
          cs="$(swift package compute-checksum build-out/BoringSSL.xcframework.zip)"
          echo "checksum=$cs" >> "$GITHUB_OUTPUT"
          printf "upstream=%s\nchecksum=%s\n" "${{ steps.gate.outputs.head }}" "$cs" > notes.txt

      - name: Release
        if: steps.gate.outputs.should == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          short="$(echo "${{ steps.gate.outputs.head }}" | cut -c1-12)"
          tag="ios-$(date +%Y%m%d)-$short"
          gh release create "$tag" build-out/BoringSSL.xcframework.zip \
            --title "$tag" \
            --notes-file notes.txt

      - name: Commit state
        if: steps.gate.outputs.should == '1'
        run: |
          mkdir -p ci
          echo "${{ steps.gate.outputs.head }}" > ci/upstream_head.txt
          echo "${{ steps.gate.outputs.now }}"  > ci/last_success_epoch.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add ci/upstream_head.txt ci/last_success_epoch.txt
          git commit -m "ci: update state" || true
          git push || true
