name: boringssl-ios-xc
on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"
permissions:
  contents: write
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install deps
        run: |
          set -euo pipefail
          sudo softwareupdate --install-rosetta --agree-to-license || true
          brew update
          brew install cmake ninja unzip || true
      - name: Gate
        id: gate
        run: |
          set -euo pipefail
          ROOT="$PWD"
          CFG="$ROOT/ci/boringssl-upstream.txt"
          REPO="$(awk -F= '/^repo=/{print $2}' "$CFG" 2>/dev/null|tail -n 1)"
          BRANCH="$(awk -F= '/^branch=/{print $2}' "$CFG" 2>/dev/null|tail -n 1)"
          [ -n "${REPO:-}" ]||REPO="https://boringssl.googlesource.com/boringssl"
          if [ -z "${BRANCH:-}" ]; then
            BRANCH="$(git ls-remote --symref "$REPO" HEAD 2>/dev/null|awk '/^ref:/{print $2}'|sed 's@refs/heads/@@')"
          fi
          [ -n "${BRANCH:-}" ]||BRANCH="main"
          LAST_FILE="$ROOT/ci/last_success_epoch.txt"
          UP_FILE="$ROOT/ci/upstream_head.txt"
          now="$(date +%s)"
          last=0
          if [ -f "$LAST_FILE" ]; then last="$(tr -d '\r\n ' <"$LAST_FILE"||echo 0)"; fi
          if [ -n "${last:-}" ] && [ "$last" -gt 0 ] 2>/dev/null; then age="$((now-last))"; else age=999999999; fi
          tmp="$(mktemp -d)"
          git clone --depth 1 --branch "$BRANCH" "$REPO" "$tmp/up"
          head="$(git -C "$tmp/up" rev-parse HEAD)"
          rm -rf "$tmp"
          prev=""
          if [ -f "$UP_FILE" ]; then prev="$(tr -d '\r\n ' <"$UP_FILE"||true)"; fi
          should=1
          if [ "$age" -lt 1209600 ]; then should=0; fi
          if [ -n "${prev:-}" ] && [ "$head" = "$prev" ]; then should=0; fi
          echo "head=$head" >> "$GITHUB_OUTPUT"
          echo "now=$now" >> "$GITHUB_OUTPUT"
          echo "should=$should" >> "$GITHUB_OUTPUT"
      - name: Build
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          chmod +x ci/build_boringssl_ios.sh
          ./ci/build_boringssl_ios.sh
      - name: Verify outputs
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          test -f build-out/BoringSSL.xcframework.zip
      - name: Compute checksum + notes
        if: steps.gate.outputs.should == '1'
        id: sum
        run: |
          set -euo pipefail
          cs="$(swift package compute-checksum build-out/BoringSSL.xcframework.zip)"
          echo "checksum=$cs" >> "$GITHUB_OUTPUT"
          printf "upstream=%s\nchecksum=%s\n" "${{ steps.gate.outputs.head }}" "$cs" > /tmp/release-notes.txt
      - name: Publish release
        if: steps.gate.outputs.should == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          short="$(echo "${{ steps.gate.outputs.head }}" | cut -c1-12)"
          tag="ios-$(date +%Y%m%d)-${short}"
          gh release create "$tag" build-out/BoringSSL.xcframework.zip --title "$tag" --notes-file /tmp/release-notes.txt
      - name: Commit state
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          mkdir -p ci
          printf "%s\n" "${{ steps.gate.outputs.head }}" > ci/upstream_head.txt
          printf "%s\n" "${{ steps.gate.outputs.now }}" > ci/last_success_epoch.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add ci/upstream_head.txt ci/last_success_epoch.txt
          git commit -m "ci: update state" || true
          git push || true
